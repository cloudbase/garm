import"../chunks/DsnmJJEf.js";import{i as X}from"../chunks/De-I_rkH.js";import{p as Y,f as S,b,c as Z,d as h,q as f,u as d,r as v,t as O,e as j,A as _e,a as ee,o as ye,B as be,l as L,h as xe,j as Se,g as t,m as c,$ as ke,v as Ce,s as w,k as a}from"../chunks/BIqNNOMq.js";import{p as Ie,i as T}from"../chunks/CfI2BFUj.js";import{d as M,c as F,g as V}from"../chunks/CQh-7xkh.js";import{D as Pe}from"../chunks/Db7N5hjl.js";import{P as we}from"../chunks/Cq4AwQWc.js";import{S as Te}from"../chunks/BKBUu_Ci.js";import{w as De}from"../chunks/C4VNo_Nu.js";import{t as $e}from"../chunks/DgRPqjXE.js";import{D as Ae,G as Ee,A as Le}from"../chunks/BjNB1vhO.js";import{e as Me}from"../chunks/BZiHL9L3.js";import{E as Fe}from"../chunks/C6HeU_02.js";import"../chunks/CYb6_lpF.js";import{S as H}from"../chunks/DCu5KXBe.js";var Ne=S('<a class="text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 truncate block text-sm"> </a>'),Re=S('<a class="text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 truncate block text-sm"> </a>'),Ge=S('<span class="text-gray-400 dark:text-gray-500 text-sm">-</span>'),He=S('<div class="w-full min-w-0 text-sm font-medium"><!></div>');function Oe(N,D){Y(D,!1);let l=Ie(D,"item",8);X();var p=He(),$=h(p);{var u=o=>{var m=Ne(),_=h(m);v(m),O(k=>{F(m,"href",k),F(m,"title",`Pool: ${f(l()),d(()=>l().pool_id)??""}`),j(_,`Pool: ${f(l()),d(()=>l().pool_id)??""}`)},[()=>(f(M),f(l()),d(()=>M(`/pools/${l().pool_id}`)))]),b(o,m)},P=o=>{var m=_e(),_=ee(m);{var k=s=>{var n=Re(),y=h(n);v(n),O(I=>{F(n,"href",I),F(n,"title",`Scale Set: ${f(l()),d(()=>l().scale_set_id)??""}`),j(y,`Scale Set: ${f(l()),d(()=>l().scale_set_id)??""}`)},[()=>(f(M),f(l()),d(()=>M(`/scalesets/${l().scale_set_id}`)))]),b(s,n)},C=s=>{var n=Ge();b(s,n)};T(_,s=>{f(l()),d(()=>l()?.scale_set_id)?s(k):s(C,!1)},!0)}b(o,m)};T($,o=>{f(l()),d(()=>l()?.pool_id)?o(u):o(P,!1)})}v(p),b(N,p),Z()}var je=S('<div class="bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-800 rounded-md p-4"><div class="flex"><div class="ml-3"><h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3> <div class="mt-2 text-sm text-red-700 dark:text-red-300"> </div></div></div></div>'),qe=S('<div class="fixed inset-0 bg-black/30 dark:bg-black/50 overflow-hidden h-full w-full z-50"><div class="relative w-full h-full flex items-center justify-center p-4"><!></div></div>'),ze=S('<div class="space-y-6"><!> <!> <!></div> <!> <!>',1);function st(N,D){Y(D,!1);const l=c(),p=c(),$=c();let u=c([]),P=c(!0),o=c(""),m="",_=null,k=Date.now(),C=null,s=c(1),n=c(25),y=c(""),I=c(!1),g=c(null),A=c(!1),x=c(null);async function q(){try{a(P,!0),a(o,""),a(u,await V.listInstances())}catch(e){a(o,e instanceof Error?e.message:"Failed to load instances")}finally{a(P,!1)}}function z(e){a(g,e),a(I,!0)}function B(e){a(x,e),a(A,!0)}function R(e){if(!e.agent_id||!e.capabilities?.has_shell||e.status==="stopped")return!0;const r=e.heartbeat;if(!r)return!0;const i=new Date(r);return k-i.getTime()>6e4}async function te(){if(t(g))try{await V.deleteInstance(t(g).name),$e.success("Instance Deleted",`Instance ${t(g).name} has been deleted successfully.`)}catch(e){a(o,Me(e))}finally{a(I,!1),a(g,null)}}const ae=[{key:"name",title:"Name",cellComponent:Fe,cellProps:{entityType:"instance",showId:!0}},{key:"pool_scale_set",title:"Pool/Scale Set",flexible:!0,cellComponent:Oe},{key:"os_type",title:"OS Type",cellComponent:H,cellProps:{statusType:"os_type",statusField:"os_type"}},{key:"created",title:"Created",cellComponent:Ee,cellProps:{field:"created_at",type:"date"}},{key:"status",title:"Status",cellComponent:H,cellProps:{statusType:"instance",statusField:"status"}},{key:"runner_status",title:"Runner Status",cellComponent:H,cellProps:{statusType:"instance",statusField:"runner_status"}},{key:"actions",title:"Actions",align:"right",cellComponent:Le,cellProps:{actions:[{type:"shell",title:"Shell",ariaLabel:"Open shell",action:"shell",isDisabled:e=>R(e),disabledTitle:e=>e.capabilities?.has_shell?e.status==="stopped"?"Shell unavailable - Instance is stopped":"Shell unavailable - Agent heartbeat is stale":"Shell unavailable - Agent does not support shell"},{type:"delete",title:"Delete",ariaLabel:"Delete instance",action:"delete"}]}}],le={entityType:"instance",primaryText:{field:"name",isClickable:!0,href:"/instances/{name}"},secondaryText:{field:"provider_id"},badges:[{type:"text",field:"os_type",label:"OS"},{type:"status",field:"status"},{type:"status",field:"runner_status"}],actions:[{type:"shell",title:"Shell",handler:e=>B(e),isDisabled:e=>R(e)},{type:"delete",handler:e=>z(e)}]};function re(e){a(y,e.detail.term),a(s,1)}function se(e){a(s,e.detail.page)}function ne(e){a(n,e.detail.perPage),a(s,1)}async function oe(){try{await q()}catch(e){console.error("Retry failed:",e)}}function ie(e){}function ce(e){z(e.detail.item)}function de(e){B(e.detail.item)}function ue(e){if(e.operation==="create"){const r=e.payload;a(u,[...t(u),r])}else if(e.operation==="update"){const r=e.payload;a(u,t(u).map(i=>i.name===r.name?r:i))}else if(e.operation==="delete"){const r=e.payload.name||e.payload;a(u,t(u).filter(i=>i.name!==r))}}ye(()=>{q(),_=De.subscribeToEntity("instance",["create","update","delete"],ue),C=setInterval(()=>{k=Date.now()},1e3)}),be(()=>{_&&(_(),_=null),C&&(clearInterval(C),C=null)}),L(()=>(t(u),t(y)),()=>{a(l,t(u).filter(e=>(t(y)===""||e.name?.toLowerCase().includes(t(y).toLowerCase())||e.provider_id?.toLowerCase().includes(t(y).toLowerCase()))&&m===""))}),L(()=>(t(l),t(n)),()=>{a(p,Math.ceil(t(l).length/t(n)))}),L(()=>(t(s),t(p)),()=>{t(s)>t(p)&&t(p)>0&&a(s,t(p))}),L(()=>(t(l),t(s),t(n)),()=>{a($,t(l).slice((t(s)-1)*t(n),t(s)*t(n)))}),xe(),X();var W=ze();Se(e=>{ke.title="Instances - GARM"});var G=ee(W),J=h(G);we(J,{title:"Runner Instances",description:"Monitor your running instances",showAction:!1});var K=w(J,2);{var pe=e=>{var r=je(),i=h(r),E=h(i),U=w(h(E),2),ge=h(U,!0);v(U),v(E),v(i),v(r),O(()=>j(ge,t(o))),b(e,r)};T(K,e=>{t(o)&&e(pe)})}var me=w(K,2);{let e=Ce(()=>!!t(o));Ae(me,{get columns(){return ae},get data(){return t($)},get loading(){return t(P)},get error(){return t(o)},get searchTerm(){return t(y)},searchPlaceholder:"Search instances...",get currentPage(){return t(s)},get perPage(){return t(n)},get totalPages(){return t(p)},get totalItems(){return t(l),d(()=>t(l).length)},itemName:"instances",emptyIconType:"cog",get showRetry(){return t(e)},get mobileCardConfig(){return le},$$events:{search:re,pageChange:se,perPageChange:ne,retry:oe,edit:ie,delete:ce,shell:de}})}v(G);var Q=w(G,2);{var fe=e=>{var r=qe(),i=h(r),E=h(i);Te(E,{get runnerName(){return t(x),d(()=>t(x).name)},onClose:()=>{a(A,!1),a(x,null)}}),v(i),v(r),b(e,r)};T(Q,e=>{t(A),t(x),d(()=>t(A)&&t(x)&&!R(t(x)))&&e(fe)})}var he=w(Q,2);{var ve=e=>{Pe(e,{title:"Delete Instance",message:"Are you sure you want to delete this instance? This action cannot be undone.",get itemName(){return t(g),d(()=>t(g).name)},$$events:{close:()=>{a(I,!1),a(g,null)},confirm:te}})};T(he,e=>{t(I)&&t(g)&&e(ve)})}b(N,W),Z()}export{st as component};
