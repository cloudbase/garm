import{c as he,a as R,h as ge,b as M,l as ye,f as H,s as ve}from"../chunks/CxOx-TIJ.js";import{i as _e}from"../chunks/3NxSoY2_.js";import{p as be,o as Te,x as Ce,l as w,b as Ie,f as Se,d as h,a as Pe,g as t,m as s,$ as we,c as g,s as b,e as ke,u as k,F as D,n as F,j as a,i as o,r as y,t as De}from"../chunks/DzFKsO_V.js";import{i as L}from"../chunks/B_jyf0qs.js";import{l as xe}from"../chunks/BAcG6-Ep.js";import{g as U}from"../chunks/BguOOs3x.js";import{D as Ae}from"../chunks/DL1RlOO9.js";import{P as Ee}from"../chunks/DTko0dwG.js";import{S as $e}from"../chunks/DcHRb6xX.js";import{w as Me}from"../chunks/DSHGoHxX.js";import{t as Fe}from"../chunks/li_-Mkq2.js";import{D as Le,E as Ne,I as Re,S as N,G as He,A as Ge}from"../chunks/C2FKJqnN.js";import{e as Oe}from"../chunks/BZiHL9L3.js";r[D]="src/routes/instances/+page.svelte";var je=R(H('<div class="bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-800 rounded-md p-4"><div class="flex"><div class="ml-3"><h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3> <div class="mt-2 text-sm text-red-700 dark:text-red-300"> </div></div></div></div>'),r[D],[[302,2,[[303,3,[[304,4,[[305,5],[306,5]]]]]]]]),qe=R(H('<div class="fixed inset-0 bg-black/30 dark:bg-black/50 overflow-hidden h-full w-full z-50"><div class="relative w-full h-full flex items-center justify-center p-4"><!></div></div>'),r[D],[[340,1,[[341,2]]]]),ze=R(H('<div class="space-y-6"><!> <!> <!></div> <!> <!>',1),r[D],[[294,0]]);function r(V,X){he(new.target),be(X,!1,r);const u=s(),v=s(),G=s();let c=s([]),x=s(!0),p=s(""),A="",T=null,O=Date.now(),C=null,i=s(1),m=s(25),_=s(""),I=s(!1),d=s(null),S=s(!1),f=s(null);async function j(){try{a(x,!0),a(p,""),a(c,(await F(U.listInstances()))())}catch(e){a(p,e instanceof Error?e.message:"Failed to load instances")}finally{a(x,!1)}}function q(e){a(d,e),a(I,!0)}function z(e){a(f,e),a(S,!0)}function E(e){if(!e.agent_id||!e.capabilities?.has_shell||o(e.status,"stopped"))return!0;const l=e.heartbeat;if(!l)return!0;const n=new Date(l);return O-n.getTime()>6e4}async function Y(){if(t(d))try{(await F(U.deleteInstance(t(d).name)))(),Fe.success("Instance Deleted",`Instance ${t(d).name} has been deleted successfully.`)}catch(e){a(p,Oe(e))}finally{a(I,!1),a(d,null)}}const Z=[{key:"name",title:"Name",cellComponent:Ne,cellProps:{entityType:"instance",showId:!0}},{key:"pool_scale_set",title:"Pool/Scale Set",flexible:!0,cellComponent:Re},{key:"os_type",title:"OS Type",cellComponent:N,cellProps:{statusType:"os_type",statusField:"os_type"}},{key:"created",title:"Created",cellComponent:He,cellProps:{field:"created_at",type:"date"}},{key:"status",title:"Status",cellComponent:N,cellProps:{statusType:"instance",statusField:"status"}},{key:"runner_status",title:"Runner Status",cellComponent:N,cellProps:{statusType:"instance",statusField:"runner_status"}},{key:"actions",title:"Actions",align:"right",cellComponent:Ge,cellProps:{actions:[{type:"shell",title:"Shell",ariaLabel:"Open shell",action:"shell",isDisabled:e=>E(e),disabledTitle:e=>e.capabilities?.has_shell?o(e.status,"stopped")?"Shell unavailable - Instance is stopped":"Shell unavailable - Agent heartbeat is stale":"Shell unavailable - Agent does not support shell"},{type:"delete",title:"Delete",ariaLabel:"Delete instance",action:"delete"}]}}],ee={entityType:"instance",primaryText:{field:"name",isClickable:!0,href:"/instances/{name}"},secondaryText:{field:"provider_id"},badges:[{type:"text",field:"os_type",label:"OS"},{type:"status",field:"status"},{type:"status",field:"runner_status"}],actions:[{type:"shell",title:"Shell",handler:e=>z(e),isDisabled:e=>E(e)},{type:"delete",handler:e=>q(e)}]};function te(e){a(_,e.detail.term),a(i,1)}function ae(e){a(i,e.detail.page)}function le(e){a(m,e.detail.perPage),a(i,1)}async function ne(){try{(await F(j()))()}catch(e){console.error(...xe("error","Retry failed:",e))}}function se(e){}function re(e){q(e.detail.item)}function oe(e){z(e.detail.item)}function ie(e){if(o(e.operation,"create")){const l=e.payload;a(c,[...t(c),l])}else if(o(e.operation,"update")){const l=e.payload;a(c,t(c).map(n=>o(n.name,l.name)?l:n))}else if(o(e.operation,"delete")){const l=e.payload.name||e.payload;a(c,t(c).filter(n=>o(n.name,l,!1)))}}Te(()=>{j(),T=Me.subscribeToEntity("instance",["create","update","delete"],ie),C=setInterval(()=>{O=Date.now()},1e3)}),Ce(()=>{T&&(T(),T=null),C&&(clearInterval(C),C=null)}),w(()=>(t(c),t(_)),()=>{a(u,t(c).filter(e=>{const l=o(t(_),"")||e.name?.toLowerCase().includes(t(_).toLowerCase())||e.provider_id?.toLowerCase().includes(t(_).toLowerCase()),n=o(A,"")||o(e.status,A)||o(e.runner_status,A);return l&&n}))}),w(()=>(t(u),t(m)),()=>{a(v,Math.ceil(t(u).length/t(m)))}),w(()=>(t(i),t(v)),()=>{t(i)>t(v)&&t(v)>0&&a(i,t(v))}),w(()=>(t(u),t(i),t(m)),()=>{a(G,t(u).slice((t(i)-1)*t(m),t(i)*t(m)))}),Ie(),_e();var W=ze();ge(e=>{we.title="Instances - GARM"});var $=Se(W),B=g($);h(()=>Ee(B,{title:"Runner Instances",description:"Monitor your running instances",showAction:!1}),"component",r,295,1,{componentTag:"PageHeader"});var J=b(B,2);{var ce=e=>{var l=je(),n=g(l),P=g(n),Q=b(g(P),2),fe=g(Q,!0);y(Q),y(P),y(n),y(l),De(()=>ve(fe,t(p))),M(e,l)};h(()=>L(J,e=>{t(p)&&e(ce)}),"if",r,301,1)}var de=b(J,2);{let e=ke(()=>!!t(p));h(()=>Le(de,{get columns(){return Z},get data(){return t(G)},get loading(){return t(x)},get error(){return t(p)},get searchTerm(){return t(_)},searchPlaceholder:"Search instances...",get currentPage(){return t(i)},get perPage(){return t(m)},get totalPages(){return t(v)},get totalItems(){return t(u),k(()=>t(u).length)},itemName:"instances",emptyIconType:"cog",get showRetry(){return t(e)},get mobileCardConfig(){return ee},$$events:{search:te,pageChange:ae,perPageChange:le,retry:ne,edit:se,delete:re,shell:oe}}),"component",r,313,1,{componentTag:"DataTable"})}y($);var K=b($,2);{var ue=e=>{var l=qe(),n=g(l),P=g(n);h(()=>$e(P,{get runnerName(){return t(f),k(()=>t(f).name)},onClose:()=>{a(S,!1),a(f,null)}}),"component",r,342,3,{componentTag:"ShellTerminal"}),y(n),y(l),M(e,l)};h(()=>L(K,e=>{t(S),t(f),k(()=>t(S)&&t(f)&&!E(t(f)))&&e(ue)}),"if",r,339,0)}var pe=b(K,2);{var me=e=>{h(()=>Ae(e,{title:"Delete Instance",message:"Are you sure you want to delete this instance? This action cannot be undone.",get itemName(){return t(d),k(()=>t(d).name)},$$events:{close:()=>{a(I,!1),a(d,null)},confirm:Y}}),"component",r,355,1,{componentTag:"DeleteModal"})};h(()=>L(pe,e=>{t(I)&&t(d)&&e(me)}),"if",r,354,0)}return M(V,W),Pe({...ye()})}export{r as component};
